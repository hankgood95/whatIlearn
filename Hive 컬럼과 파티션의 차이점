회사에서 교육으로 hive 쿼리를 연습할수 있게 연습용 서버를 만들어주었다.
그래서 여태 hive 쿼리로 테이블을 생성도 해보고 해당 테이블에 데이터도 파일로 집어 넣어보고 해보았다.
이번엔 특정 테이블을 컬럼과 파티션으로 만들고 해당 테이블에 데이터를 집어 넣는 것을 연습해보았다.

연습을 하는도중 컬럼과 파티션의 차이가 무엇일까라는 의문이 생겼고 이번에는 해당 질문에 대해서 자세히 알아볼 예정이다.

----------------------------------------------------------------------------------------------------------------------------------

컬럼이란?
컬럼은 우리가 데이터를 집어 넣을때의 기준이 되는 속성을 정의 해놓은 이름과 같은것이다.
말이 어렵지만 그냥 이해하기 쉽게 말하자면 사람이라는 테이블 있다고 가정을 하고 그 안에 name이라는 컬럼과 age라는 컬럼이 있다고 하면
사람이라는 테이블에 이욱재라는 데이터를 집어넣을때 name과 age에 집어 넣게 되는것이다.
그러면 이제 사람이라는 테이블에는 이욱재, 29 라는 데이터가 name와 age 라는 컬럼으로 저장되어서 값을 확인해볼수가 있다.

그럼 이제 partition에 대해서 알아보자.

partition이란?
partition은 데이터가 큰 테이블에서 하나 이상의 열을 파티션으로 지정하여서 
해당 테이블을 좀 더 작은 테이블로 나누어 관리하기 편하고 그리고 해당 테이블에서의 쿼리를 작성할때 쿼리를 좀 더 빠르게 
실행시킬수 있게 하는것이다.
이해하기 어려울수 있겠지만 이해하기 쉽게 간단히 설명하자면 큰 테이블을 특정 속성으로 파티션으로 만들어 테이블을 조금 더 작게 만들어
관리하는것이다.

예를 들어서 날짜와 시간을 기반으로 어떤 데이터가 temp라는 테이블에 꾸준히 쌓인다고 가정을 해보자.
그러면 temp 테이블은 아래와 같이 스키가마 정의 되어야 한다.

create external table temp(
  dt string,
  hh string,
  member_id string,
  name string,
  age string
)
 
이렇게 만드는게 일반적이다.
하지만 이렇게 저장을 하게 되면 데이터가 많아지면 많아질수록 hdfs에서 해당 데이터를 가진 파일의 용량은 점점 커지고
해당 테이블에서 데이터를 조회할때 또한 오랜 시간이 걸릴수가 있다.

따라서 날짜와 시간별로 파일이 생성되는 테이블이라면 날짜와 시간은 파티션으로 나누어 날짜 별로 파일을 관리하고
해당 partition 내에서 테이블 내용이 적재되는 방식으로 설계하는 방식이 옳은 방식이다.

테이블을 만든후 partition을 만드는 방법은 아래와 같다.
 
create external table temp(
  dt string,
  hh string,
  member_id string,
  name string,
  age string
)
partitioned by (dt string, hh string)
row format delimited
fields terminated by ','
location '/test/temp'
 
이렇게 되면 dt와 hh가 hdfs의 partition으로 저장이 되어 아래와 같은 파일 경로가 생기게 된다.

/test/temp/dt/hh

그리고 해당 partition에 맞춰서 데이터를 넣으려면 아래와 같이 넣어줘야 한다.

insert overwrite table temp (dt='20230326', hh='18')
--여기서부터는 values가 들어가도 되고 select 문이 들어가도 된다.--

위와 같이 insert 를 하게 되면 

/test/temp 의 경로 안에 
/test/temp/dt=20230326 폴더가 들어있고
그 안에는 
/test/temp/dt=20230326/hh=18 폴더가 들어가 있게 된다.
그리고 /test/temp/dt=20230326/hh=18 경로 안에는 이제 해당 테이블의 데이터가 들어가 있게 되는것이다.

이렇게 함으로써 데이터가 큰 테이블은 작은 테이블처럼 관리할수 있어서 데이터 관리에 굉장히 유리하다는것을 알수가 있다.

나는 여기까지 이해가 간 후 내 스스로 든 의문이 있었다.

dt와 hh를 파티션으로 나눈후 테이블 스키마로 저장하였는데 그렇담 해당 테이블에서 dt와 hh 값의 데이터는 추출할수 있을까?
였다.

당연히 dt와 hh는 테이블 안에 컬럼으로 지정하지 않아서 해당 값을 테이블에서 select dt, hh 하면 나오지 않는게 당연한대
실행시켜보면 잘 select 되는것을 알수가 있다.
그것이 잘 select 되는 이유는 일단 파티션도 마찬가지로 테이블의 스키마가 저장될때 파티션의 정보도 같이 메타데이터로 저장이 되어있어
테이블 내의 컬럼으로 저장되어이 있지 않더라도 메타 데이터의 일부라 select 되어지는것이다.

※주의※
다만 여기서 이해할때 주의할점은 파티션은 결코 테이블에 저장된 실제데이터의 일부가 아니라는것에 주의 해야한다.
대신 파티션의 값에 따라서 데이터를 개별 디렉토리에 저장시키는 용도일 뿐인것이다.
